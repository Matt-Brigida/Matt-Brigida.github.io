#+TITLE: TF Probability vs ARCH: Stock Returns


Below we'll compare tensorflow probability with a traditional ARCH/GARCH model.


#+begin_src python :session :results output :exports both 
import tensorflow as tf
import tensorflow_probability as tfp
import json
import requests
import pandas as pd
import numpy as np
from pprint import pprint
import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns
#+end_src

#+RESULTS:

** Get the data and convert into returns

#+begin_src python :session :results output :exports both

# %% function to import stock data from IEX

base_url = "https://api.iextrading.com/"
version = "1.0/"

def one_day(ticker):
    """Get 1 minute data for the last day"""
    tmp = pd.DataFrame.from_dict(requests.get(base_url + version + "/stock/" + ticker + "/chart/1d").json())
    tmp["Ticker"] = ticker
    return tmp

aapl = one_day("aapl")
spy = one_day("spy")

# %% convert minute closes to both numpy vectors and torch tensors
# %% numpy
aapl_numpy = aapl.close.values
spy_numpy = spy.close.values

## calculate returns
aapl_rets = np.diff(np.log(aapl_numpy))
spy_rets = np.diff(np.log(spy_numpy))

print(aapl_rets)
print(spy_rets)

#+end_src

#+RESULTS:
#+begin_example

... >>> >>> >>> >>> ... ... ... ... ... >>> >>> ... ... >>> >>> >>> ... >>> >>> >>> [ 1.72942422e-03 -2.61841797e-04 -5.23889367e-04 -6.81466752e-04
  7.86266585e-04 -4.19265244e-04 -3.14564331e-04 -2.15217531e-03
  2.10172342e-04  9.97715839e-04 -2.41723712e-03  3.15623359e-04
  3.68101390e-04  7.88332717e-04 -1.20903108e-03  3.68120748e-04
  4.20543559e-04 -7.36067331e-04  7.36067331e-04 -1.57683110e-04
  6.56848988e-04 -1.31335286e-04 -9.19830290e-04 -2.34281534e-03
  1.21157862e-03  1.26269286e-03  5.25776177e-05 -1.57741147e-04
 -1.05174590e-04  1.05124845e-03  1.05064089e-04 -3.67772616e-04
  5.77867684e-04 -1.68199777e-03 -8.94713357e-04 -1.84458141e-03
 -2.90551989e-03  3.70262626e-04  7.92958570e-04 -1.53362097e-03
 -7.94176084e-04  1.58772195e-03 -6.34786310e-04  7.14106273e-04
  8.72104602e-04  3.69754118e-04  1.05618927e-04 -4.22542657e-04
  5.28150430e-04 -1.16229937e-03 -4.22989484e-04  1.05764146e-04
  2.11494740e-04 -1.53435124e-03 -5.29506765e-05 -3.17762952e-04
 -7.94849418e-04  6.35930069e-04  9.79600560e-04  2.38136189e-04
 -8.46964213e-04  3.70635114e-04 -5.56004198e-04  4.23650283e-04
 -7.67998343e-04  3.97314162e-04 -3.70821639e-04 -5.03477983e-04
  3.18015585e-04 -5.29955749e-05 -4.77086600e-04  4.24088217e-04
 -7.42272448e-04 -3.44813870e-04  7.69037018e-04  6.35997477e-04
  5.29689085e-04 -5.29562846e-05  6.35290402e-04 -1.85251347e-04
  7.14351888e-04 -1.58700770e-04  0.00000000e+00  1.00467978e-03
  4.22721274e-04  7.92121078e-04 -1.58374027e-04 -3.16823321e-04
  2.64026404e-04  5.27843771e-04 -1.58323878e-04  1.95091148e-03
  1.31603209e-03 -4.73572058e-04  4.47268382e-04  1.05160774e-03
 -1.83951542e-04  7.88405188e-05 -3.94264767e-04 -3.15523772e-04
  0.00000000e+00  3.68101390e-04  5.25748535e-05 -3.15490590e-04
 -2.10382371e-04  2.62971048e-04 -3.68178834e-04 -5.26080438e-05
 -7.36803359e-04  1.57932142e-04 -1.05285323e-04  2.10559563e-04
  9.99552915e-04 -6.83796676e-04  7.88954676e-04 -1.05158000e-04
  4.73123941e-04 -7.36067331e-04  2.10360243e-04  5.25831471e-05
 -2.62943390e-04  1.05185653e-04  2.10338119e-04 -1.15740754e-03
 -2.63234096e-04  5.26523628e-05  1.57940457e-04  4.21052638e-04
 -3.15772857e-04 -5.26385051e-05 -2.63234096e-04 -1.05313043e-04
 -2.63331140e-04 -6.32277802e-04  5.79603251e-04  5.26620687e-04
  5.26468188e-05  5.26315802e-04  4.20853286e-04 -1.05196718e-04
  2.62971048e-04 -2.10371306e-04  4.73273219e-04 -1.20992150e-03
  5.52537080e-04  2.63036759e-05  5.26052763e-05  3.94451389e-04
  2.62912279e-05 -5.25831471e-05  7.88736838e-05  5.51941666e-04
  5.77898043e-04 -2.10106104e-04 -5.25458475e-04  5.77989139e-04
 -1.36669491e-03 -6.84048541e-04 -3.15872601e-04  2.10592820e-04
  6.84120537e-04  1.05207785e-04  1.05196718e-04 -5.26094288e-04
  2.10470929e-04  3.68217568e-04  5.25914434e-05  1.05174590e-04
 -1.05174590e-04 -1.05185653e-04 -1.31497627e-04 -1.31514921e-04
  3.68198200e-04 -2.36683279e-04 -2.63047140e-04  2.36745539e-04
  2.62984880e-04  2.89203509e-04  2.62839722e-04 -7.88446629e-05
  1.05124836e-04 -1.57691398e-04 -1.57716269e-04  1.57716269e-04
  2.62805184e-04  1.05102738e-04  2.10172342e-04 -3.15275080e-04
 -1.05113786e-04  1.57666536e-04 -2.89074307e-04 -7.88529524e-05
 -3.68062680e-04  3.15490590e-04 -2.10316001e-04  5.78262600e-04
 -1.05113786e-04  0.00000000e+00  1.57666536e-04  5.25499882e-05
 -2.62777560e-04  1.57674822e-04  2.10194431e-04 -2.10194431e-04
 -5.25555118e-05  1.05108262e-04  3.67791939e-04  8.92646230e-04
  1.04964837e-04  0.00000000e+00  1.57426600e-04  1.04937300e-04
  2.09841570e-04 -5.24562646e-05 -4.72230247e-04 -3.67444428e-04
 -3.67579493e-04 -1.83840427e-04 -1.83874231e-04 -2.10183386e-04
 -2.62791371e-04  2.10238622e-04  2.62767201e-05 -6.04539320e-04
  2.10316001e-04 -1.18360329e-03  3.94690108e-04  6.83760710e-04
 -6.04841379e-04  1.31518380e-04  2.62984880e-04 -5.25914434e-05
  1.57766033e-04  7.88736838e-05 -7.88736838e-05  2.62888090e-04
 -1.57724561e-04  1.05152471e-04  5.25720895e-05 -3.15474002e-04
  5.25859122e-05  2.62888090e-04  4.73024475e-04  4.20278441e-04
 -4.72825667e-04  2.10172342e-04  1.57600273e-04 -4.72875354e-04
  2.62736136e-04  1.57608553e-04  1.05058570e-04 -1.57591995e-04
  3.15159158e-04 -2.10095069e-04  1.05053052e-04  7.87546309e-04
  1.57434862e-04 -3.14894513e-04  0.00000000e+00  1.04975856e-04
  0.00000000e+00  3.14861464e-04  2.09852579e-04 -1.57385306e-04
  4.19639117e-04  3.14613814e-04 -1.04860274e-04 -1.04871271e-04
  1.57302782e-04  1.57278042e-04  2.09665584e-04 -1.57245067e-04
 -9.96460027e-04  2.62353574e-05 -2.36142999e-04  2.09907641e-04
  2.09863589e-04  2.62298522e-05 -7.86916207e-05  1.57377050e-04
  1.04904275e-04 -7.86771745e-05 -5.24548888e-05 -2.36081056e-04
 -2.62346691e-05 -3.93602650e-04  2.09940693e-04 -3.14927569e-04
  0.00000000e+00  5.24824196e-04  0.00000000e+00  3.14762357e-04
  5.24507619e-05 -1.57360540e-04  3.67136080e-04  1.57302782e-04
  3.14531351e-04 -6.81609674e-04 -2.62281324e-04  5.76928136e-04
  0.00000000e+00  2.62130070e-04 -3.67001341e-04  2.09731544e-04
 -1.04860274e-04 -5.76928136e-04  0.00000000e+00  1.83604150e-04
  5.24521374e-05  4.98158136e-04 -1.57286288e-04  3.14547840e-04
 -2.62116329e-04  2.62147248e-05 -2.88399777e-04  6.81538206e-04
  2.09610649e-04  1.04788851e-04 -4.45428470e-04  2.35839787e-04
 -3.14465411e-04  1.04832792e-04  0.00000000e+00  0.00000000e+00
  3.14432452e-04  1.57179158e-04  5.23752172e-04  1.57072175e-04
  4.18738556e-04 -5.75810731e-04  3.66463371e-04  2.09347360e-04
  1.56981764e-04 -2.09314496e-04 -1.04673680e-04 -5.23409490e-05
 -5.23436887e-05 -1.57047507e-04 -3.14169026e-04 -7.33445129e-04
  1.57212106e-04  4.19111490e-04 -4.71512779e-04  4.71512779e-04
  0.00000000e+00  3.66578517e-04 -1.04723008e-04  4.71167195e-04
  2.61694472e-05 -4.97336642e-04  3.40309685e-04 -2.61735569e-05
 -5.23491690e-05 -5.23519095e-05  0.00000000e+00  5.23519095e-05
  1.30867784e-04 -7.85186155e-05  5.23341021e-04  0.00000000e+00
 -1.56973550e-04  5.23272547e-05 -5.75750454e-04  1.83229286e-04
  2.61728718e-05 -1.57047507e-04  1.57047507e-04 -3.14119682e-04
  1.04717525e-04  1.83229286e-04  5.23450586e-05 -2.35574344e-04
  7.06556613e-04 -2.35463406e-04  2.61622585e-04 -5.23190415e-05
 -6.01865802e-04 -2.87976964e-04  4.71191862e-04  5.23409490e-05
 -5.23409490e-05  1.57014629e-04  2.87796138e-04  1.30789051e-04
  8.36645102e-04 -1.56817648e-04 -3.39855957e-04 -2.87660667e-04
  4.70674380e-04]
[-2.80967936e-04  4.91642094e-04 -1.40444507e-04  7.02247191e-05
  0.00000000e+00 -1.75571045e-04 -1.75601876e-04 -6.32422198e-04
  1.75712956e-04  2.81076525e-04 -4.91935777e-04  1.40577775e-04
 -2.81175315e-04  2.81175315e-04  1.75708324e-05 -1.93296139e-04
  1.75725307e-04 -2.10874074e-04  2.10874074e-04  2.63530075e-04
  8.78279276e-05  2.45877168e-04  0.00000000e+00 -5.44523599e-04
  2.63516186e-04 -4.56805532e-04  1.40577775e-04  1.05420364e-04
 -2.98719900e-04  1.59799144e-03  1.75447831e-04  2.80652519e-04
 -2.10482005e-04 -1.05257618e-04  1.05257618e-04 -4.56196383e-04
  7.01976063e-05 -4.21259572e-04 -3.68747754e-04 -2.98609711e-04
  3.16172211e-04  3.51185254e-04 -2.80938336e-04 -1.40498771e-04
  4.03880773e-04  8.77785873e-05  1.75534063e-04 -1.40424785e-04
  3.51024997e-04  1.75466302e-04 -1.40370579e-04 -1.75490936e-04
  1.05298257e-04 -4.56372548e-04  1.75552552e-04 -7.02173226e-05
 -3.16038981e-04  0.00000000e+00  2.10703751e-04  2.45764945e-04
 -2.45764945e-04  7.02247191e-05 -3.51117431e-05  7.02222535e-05
 -2.80918606e-04  1.40469167e-04  1.40449438e-04  3.51092776e-05
  1.57976497e-04  1.22853357e-04 -2.45721809e-04  2.45721809e-04
  7.01951425e-05 -1.57946000e-04  1.75507876e-05 -1.05309346e-04
  3.51043477e-05 -1.05316740e-04 -7.02173226e-05  3.51092776e-05
 -1.22887865e-04  0.00000000e+00  5.26680770e-05  1.57987590e-04
  1.22861982e-04  3.51006511e-05 -5.26514387e-05 -5.26542110e-05
 -3.51043477e-05 -8.77662610e-05 -1.75541766e-05  4.91400501e-04
  2.10526317e-04 -2.10526317e-04  0.00000000e+00  2.80691907e-04
  5.26209624e-05  3.50791034e-05  8.76923752e-05 -2.10474621e-04
  2.45549418e-04 -1.05228082e-04 -1.05239156e-04  7.01606680e-05
 -8.77016041e-05  4.38431125e-04  3.50661874e-05  2.10371306e-04
 -2.10371306e-04 -7.01336045e-05 -2.98122706e-04  7.01545153e-05
  1.92899544e-04  3.50686469e-05 -1.75355534e-04  1.05217010e-04
 -3.15684248e-04  2.10467238e-04 -3.50747970e-05 -2.80642674e-04
 -3.50858727e-05 -7.01754386e-05 -7.01803636e-05  7.01803636e-05
  1.40345953e-04 -1.05257618e-04  1.05257618e-04 -3.50846417e-05
 -2.45626964e-04 -7.01902155e-05  3.50957236e-05  0.00000000e+00
 -4.21229998e-04 -1.22892180e-04  1.75555634e-04 -1.75541766e-05
  1.40424785e-04  1.05305650e-04  3.50938765e-04 -3.50883349e-05
 -7.01803636e-05  1.05268698e-04  1.22799477e-04 -2.28068176e-04
  1.92984150e-04  1.75421670e-05  1.40326259e-04  2.80593457e-04
 -2.45514969e-04 -2.45575261e-04 -1.40355802e-04  2.10526317e-04
  8.77062193e-05 -1.57876734e-04 -1.05265005e-04 -1.05276087e-04
 -1.75484777e-04 -1.57962633e-04  1.93062052e-04 -8.77508578e-05
  2.98321505e-04 -7.01852892e-05  7.01852892e-05 -2.45670066e-04
  1.40390285e-04  0.00000000e+00  4.56132356e-04  7.01557458e-05
  1.40296728e-04 -7.01459035e-05  3.50735668e-05  1.75349384e-04
  1.05194874e-04 -1.75330938e-04 -1.75361684e-04  0.00000000e+00
  1.05220701e-04 -1.75360146e-05  1.22745645e-04 -7.01385236e-05
  1.75337086e-04 -1.22732732e-04 -1.22747797e-04  2.45480529e-04
 -2.10408193e-04 -3.50723367e-05  1.75363221e-05 -5.26098889e-05
  7.01459035e-05  1.75343235e-04  3.50649578e-05 -1.75337086e-04
  0.00000000e+00  1.05205941e-04  1.75318642e-04  3.50600403e-05
  7.01163932e-05 -3.50575821e-05  0.00000000e+00  0.00000000e+00
 -1.57774330e-04             nan             nan  7.01163932e-05
 -7.01163932e-05 -3.50600403e-05  3.50545101e-04  1.05139573e-04
  8.76078672e-05 -1.22653163e-04  2.10253356e-04 -1.75194247e-05
  8.75940542e-05 -5.25555118e-05 -1.92727178e-04 -1.40188554e-04
  7.00967335e-05  1.75220340e-04  1.05117469e-04 -1.75201921e-04
 -1.40183641e-04 -3.50489810e-05 -3.50502094e-05  0.00000000e+00
  1.75238763e-04 -1.75238763e-04  0.00000000e+00  7.00991904e-05
 -2.45368668e-04 -2.10363930e-04  1.40247537e-04  7.01163932e-05
  7.01114773e-05  3.50538954e-05 -1.75281766e-04  7.01163932e-05
  3.50508241e-04  0.00000000e+00 -3.50452960e-05 -3.50465243e-05
 -7.00967335e-05  3.50489810e-05  2.45308477e-04 -1.05124836e-04
 -7.00893640e-05  1.05132204e-04  1.75195782e-04 -5.25555118e-05
  8.75909852e-05  3.50342460e-05  3.50330186e-05 -7.00672646e-05
 -1.05110103e-04 -3.50391563e-05  1.05113786e-04  3.32787448e-04
 -1.57622355e-04 -1.75165094e-04 -8.75940542e-05  1.22629528e-04
  1.22614491e-04  1.75151287e-05  1.05084330e-04 -2.10179704e-04
  3.15252993e-04 -1.75114481e-05 -3.50238162e-05  1.75120614e-05
  1.05065929e-04 -7.00427261e-05  3.50164581e-04  7.00182048e-05
 -8.75235220e-05  8.75235220e-05 -1.75054705e-04  1.05036500e-04
  1.05025469e-04  1.40016802e-04  7.00010500e-05  3.49986876e-05
  8.74913603e-05  1.74973535e-05 -2.09988451e-04 -3.50023627e-05
  1.75013345e-05 -8.75097355e-05 -1.05021792e-04  3.50084896e-05
  3.50072640e-05 -5.25113556e-05 -5.25141132e-05  7.00182048e-05
 -7.00182048e-05  0.00000000e+00  7.00182048e-05 -3.50084896e-05
  2.45033693e-04 -3.85079909e-04 -2.45128081e-04  1.05062249e-04
  3.50182971e-05  1.05047534e-04  0.00000000e+00  1.40046215e-04
  0.00000000e+00 -1.22539366e-04 -1.75068496e-05 -3.50146186e-05
  8.75342478e-05  8.75265863e-05  3.50084896e-05 -3.50084896e-05
 -3.50097152e-05 -1.40051119e-04 -2.27624910e-04  1.92609065e-04
 -3.50170708e-05  1.05047534e-04 -1.40065831e-04  1.75079224e-04
 -2.10098747e-04 -1.75102216e-05 -1.75105282e-05  1.40075641e-04
  1.05043856e-04  1.75048576e-04  1.40016802e-04 -2.45042271e-04
 -3.50109409e-05 -4.90281922e-04  1.22593018e-04  1.05067769e-04
  1.75102216e-05 -2.10142898e-04 -7.00574471e-05  1.40109987e-04
 -1.75140551e-04 -1.05099056e-04  0.00000000e+00 -3.15363459e-04
  1.92733931e-04  2.62759148e-04 -3.50305642e-05  8.75741096e-05
  1.75139017e-05  2.80180718e-04 -1.05058570e-04  1.92598948e-04
  1.57553372e-04 -7.00206561e-05  3.50109409e-05 -7.00231077e-05
  1.05032823e-04  2.45033693e-04 -1.75017940e-04 -7.00157536e-05
  2.62533803e-04 -8.75036096e-05  2.27493461e-04 -6.99924758e-05
  0.00000000e+00  1.74985782e-05 -3.50029756e-04  3.50084896e-05
  1.05018116e-04  1.05007088e-04  1.92484361e-04 -2.27485499e-04
  1.92491098e-04  8.74837062e-05  3.49913396e-05 -2.79965006e-04
  6.99986001e-05  2.09966406e-04 -1.57470671e-04  2.09955385e-04
 -2.27453657e-04 -6.99961502e-05  1.39987401e-04  1.74970474e-05
  1.92447318e-04  1.04955656e-04  5.24736976e-05  3.32269491e-04
  3.32159125e-04  3.14575326e-04 -3.49534249e-04  6.99166245e-05
             nan]
#+end_example


*** Take a look at the data

#+begin_src python :session :results output :exports both
sns.distplot(aapl_rets)
plt.title("AAPL")
plt.show()
#+end_src

#+RESULTS:
: <matplotlib.axes._subplots.AxesSubplot object at 0x7f2e1a2b7898>
: Text(0.5, 1.0, 'AAPL')



** Create TF Probability Model
   



